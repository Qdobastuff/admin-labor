<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Labor Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .controls {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .controls-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .control-group.full-width {
            flex: 100%;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .store-selector {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .district-section {
            margin-bottom: 20px;
        }
        
        .district-section:last-child {
            margin-bottom: 0;
        }
        
        .district-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
        }
        
        .district-header:hover {
            background: #e9ecef;
        }
        
        .district-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .district-name {
            font-weight: 700;
            color: #667eea;
            font-size: 15px;
        }
        
        .store-list {
            margin-left: 28px;
            display: grid;
            gap: 8px;
        }
        
        .store-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .store-item:hover {
            background: #f8f9fa;
        }
        
        .store-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .store-label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }
        
        .percentage-good {
            color: #10b981;
        }
        
        .percentage-warning {
            color: #f59e0b;
        }
        
        .percentage-danger {
            color: #ef4444;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px 24px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 20px;
            color: #333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px 24px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tr {
            border-bottom: 1px solid #f0f0f0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .store-name {
            font-weight: 600;
            color: #333;
        }
        
        .amount {
            font-family: 'Courier New', monospace;
            color: #333;
        }
        
        .no-data {
            padding: 60px;
            text-align: center;
            color: #999;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Manager Dashboard</h1>
            <p id="current-date"></p>
        </div>
        
        <div class="controls">
            <div class="control-group full-width">
                <label>Filter by Store(s)</label>
                <div class="store-selector" id="storeSelector"></div>
            </div>
            
            <div class="controls-row">
                <div class="control-group">
                    <label for="viewMode">View Mode</label>
                    <select id="viewMode">
                        <option value="day">Day</option>
                        <option value="daterange">Date Range</option>
                    </select>
                </div>
                
                <div class="control-group" id="dateControl">
                    <label for="dateFilter">Date</label>
                    <input type="date" id="dateFilter">
                </div>
                
                <div class="control-group" id="startDateControl" style="display:none;">
                    <label for="startDateFilter">Start Date</label>
                    <input type="date" id="startDateFilter">
                </div>
                
                <div class="control-group" id="endDateControl" style="display:none;">
                    <label for="endDateFilter">End Date</label>
                    <input type="date" id="endDateFilter">
                </div>
                
                <div class="control-group">
                    <label for="timeFilter">Check Time</label>
                    <select id="timeFilter">
                        <option value="">All Times</option>
                        <option value="1pm">1pm</option>
                        <option value="4pm">4pm</option>
                        <option value="7pm">7pm</option>
                        <option value="Close">Close</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="refreshData()">ðŸ”„ Refresh</button>
                </div>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total Entries</div>
                <div class="stat-value" id="totalEntries">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Sales</div>
                <div class="stat-value" id="totalSales">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Labor</div>
                <div class="stat-value" id="totalLabor">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Labor %</div>
                <div class="stat-value" id="avgPercentage">0%</div>
            </div>
        </div>
        
        <div class="data-table">
            <div class="table-header">
                <h2>Labor Entries</h2>
                <button onclick="exportToCSV()">ðŸ“¥ Export CSV</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Store</th>
                        <th>Check Time</th>
                        <th>Gross Sales</th>
                        <th>Labor Dollars</th>
                        <th>Labor %</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCg6sdwxr788HymNLHF3skIro7P6SWrvHE",
            authDomain: "labor-tracker-bbbaa.firebaseapp.com",
            projectId: "labor-tracker-bbbaa",
            storageBucket: "labor-tracker-bbbaa.firebasestorage.app",
            messagingSenderId: "939951401620",
            appId: "1:939951401620:web:f2cd20c38c8e36a5466281"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const districtStores = {
            "Benedict": [
                { id: "2444", name: "Richmond" },
                { id: "2524", name: "Palomar" },
                { id: "2842", name: "Georgetown" },
                { id: "3286", name: "Danville" }
            ],
            "Faluconer": [
                { id: "2086", name: "Euclid" },
                { id: "2114", name: "Frankfort" },
                { id: "2294", name: "Sir Barton" },
                { id: "2521", name: "Tiverton" }
            ],
            "Maddox": [
                { id: "2274", name: "Hurstborne" },
                { id: "2546", name: "Preston" },
                { id: "2811", name: "Middletown" },
                { id: "2837", name: "Harley Center" }
            ],
            "Reid": [
                { id: "2098", name: "Summit" },
                { id: "2131", name: "Charlestown" },
                { id: "2431", name: "Poplar Level" },
                { id: "2641", name: "Dixie Hwy" },
                { id: "2731", name: "Veterans" },
                { id: "2880", name: "Wesley Commons" },
                { id: "3044", name: "Jeffersonville IN" },
                { id: "2166", name: "Carson" }
            ],
            "Spitznagel": [
                { id: "2021", name: "Breckenridge Ln" },
                { id: "2029", name: "Schuster" },
                { id: "2493", name: "Westport Village" },
                { id: "2632", name: "S 4th Street" },
                { id: "2713", name: "U OF L" },
                { id: "2753", name: "Blankenbaker" },
                { id: "2888", name: "Elizabethtown" },
                { id: "2937", name: "Jefferson Commons" }
            ]
        };
        
        let selectedStores = new Set();
        // Start with no stores selected
        
        // Build store selector
        function buildStoreSelector() {
            console.log('Building store selector...');
            const selector = document.getElementById('storeSelector');
            console.log('Selector element:', selector);
            
            if (!selector) {
                console.error('Store selector element not found!');
                return;
            }
            
            Object.keys(districtStores).forEach(districtName => {
                console.log('Building district:', districtName);
                const districtSection = document.createElement('div');
                districtSection.className = 'district-section';
                
                const districtHeader = document.createElement('div');
                districtHeader.className = 'district-header';
                
                const districtCheckbox = document.createElement('input');
                districtCheckbox.type = 'checkbox';
                districtCheckbox.className = 'district-checkbox';
                districtCheckbox.checked = false;
                
                const districtLabel = document.createElement('span');
                districtLabel.className = 'district-name';
                districtLabel.textContent = districtName;
                
                districtHeader.appendChild(districtCheckbox);
                districtHeader.appendChild(districtLabel);
                
                districtHeader.addEventListener('click', (e) => {
                    if (e.target !== districtCheckbox) {
                        districtCheckbox.checked = !districtCheckbox.checked;
                    }
                    // Toggle all stores in district
                    districtStores[districtName].forEach(store => {
                        const storeValue = `${store.id} - ${store.name}`;
                        const storeCheckbox = document.getElementById(`store-${store.id}`);
                        if (storeCheckbox) {
                            storeCheckbox.checked = districtCheckbox.checked;
                            if (districtCheckbox.checked) {
                                selectedStores.add(storeValue);
                            } else {
                                selectedStores.delete(storeValue);
                            }
                        }
                    });
                    refreshData();
                });
                
                const storeList = document.createElement('div');
                storeList.className = 'store-list';
                
                districtStores[districtName].forEach(store => {
                    const storeItem = document.createElement('div');
                    storeItem.className = 'store-item';
                    
                    const storeCheckbox = document.createElement('input');
                    storeCheckbox.type = 'checkbox';
                    storeCheckbox.className = 'store-checkbox';
                    storeCheckbox.id = `store-${store.id}`;
                    storeCheckbox.checked = false;
                    
                    const storeLabel = document.createElement('label');
                    storeLabel.className = 'store-label';
                    storeLabel.textContent = `${store.id} - ${store.name}`;
                    
                    const storeValue = `${store.id} - ${store.name}`;
                    storeCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedStores.add(storeValue);
                        } else {
                            selectedStores.delete(storeValue);
                        }
                        refreshData();
                    });
                    
                    storeItem.appendChild(storeCheckbox);
                    storeItem.appendChild(storeLabel);
                    storeList.appendChild(storeItem);
                });
                
                districtSection.appendChild(districtHeader);
                districtSection.appendChild(storeList);
                selector.appendChild(districtSection);
            });
            console.log('Store selector built successfully!');
        }
        
        // View mode change
        const viewMode = document.getElementById('viewMode');
        const dateControl = document.getElementById('dateControl');
        const startDateControl = document.getElementById('startDateControl');
        const endDateControl = document.getElementById('endDateControl');
        
        viewMode.addEventListener('change', () => {
            const mode = viewMode.value;
            
            if (mode === 'day') {
                dateControl.style.display = 'block';
                startDateControl.style.display = 'none';
                endDateControl.style.display = 'none';
            } else if (mode === 'daterange') {
                dateControl.style.display = 'none';
                startDateControl.style.display = 'block';
                endDateControl.style.display = 'block';
            }
            
            refreshData();
        });
        
        // Set today's date
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById('dateFilter').value = todayStr;
        document.getElementById('startDateFilter').value = todayStr;
        document.getElementById('endDateFilter').value = todayStr;
        
        // Load data
        async function loadData() {
            console.log('=== LOAD DATA CALLED ===');
            const mode = viewMode.value;
            const timeFilter = document.getElementById('timeFilter').value;
            
            let startDate, endDate;
            
            if (mode === 'day') {
                startDate = endDate = document.getElementById('dateFilter').value;
            } else {
                startDate = document.getElementById('startDateFilter').value;
                endDate = document.getElementById('endDateFilter').value;
            }
            
            console.log('Mode:', mode);
            console.log('Date range:', startDate, 'to', endDate);
            console.log('Time filter:', timeFilter);
            console.log('Selected stores:', selectedStores.size);
            
            if (!startDate || !endDate) {
                console.log('No dates selected, returning empty array');
                return [];
            }
            
            try {
                console.log('Querying Firestore...');
                let q = db.collection('labor_entries')
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate);
                
                const querySnapshot = await q.get();
                console.log('Query returned', querySnapshot.size, 'documents');
                
                let entries = [];
                querySnapshot.forEach((doc) => {
                    entries.push(doc.data());
                });
                
                console.log('Before filtering:', entries.length, 'entries');
                
                // Filter by selected stores
                if (selectedStores.size > 0) {
                    entries = entries.filter(entry => {
                        const matches = selectedStores.has(entry.store);
                        if (!matches) {
                            console.log('Filtering out:', entry.store);
                        }
                        return matches;
                    });
                    console.log('After store filter:', entries.length, 'entries');
                }
                
                // Filter by time
                if (timeFilter) {
                    entries = entries.filter(e => e.checkTime === timeFilter);
                    console.log('After time filter:', entries.length, 'entries');
                }
                
                return entries;
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }
        
        // Refresh data
        window.refreshData = async function() {
            console.log('=== REFRESH DATA CALLED ===');
            try {
                const entries = await loadData();
                console.log('Loaded entries:', entries.length);
                console.log('Entries data:', entries);
                
                // Update stats
                document.getElementById('totalEntries').textContent = entries.length;
                
                const totalSales = entries.reduce((sum, e) => sum + parseFloat(e.grossSales || 0), 0);
                document.getElementById('totalSales').textContent = '$' + totalSales.toFixed(2);
                
                const totalLabor = entries.reduce((sum, e) => sum + parseFloat(e.laborDollars || 0), 0);
                document.getElementById('totalLabor').textContent = '$' + totalLabor.toFixed(2);
                
                const avgPct = totalSales > 0 ? ((totalLabor / totalSales) * 100).toFixed(1) : '0.0';
                const avgEl = document.getElementById('avgPercentage');
                avgEl.textContent = avgPct + '%';
                avgEl.className = 'stat-value ' + 
                    (parseFloat(avgPct) < 30 ? 'percentage-good' : 
                     parseFloat(avgPct) < 35 ? 'percentage-warning' : 'percentage-danger');
                
                console.log('Stats updated');
                
                // Update table
                const tbody = document.getElementById('dataTable');
                if (entries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No data for selected filters</td></tr>';
                    console.log('No entries found');
                } else {
                    tbody.innerHTML = entries
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .map(entry => {
                            const pct = parseFloat(entry.percentage);
                            const pctClass = pct < 30 ? 'percentage-good' : pct < 35 ? 'percentage-warning' : 'percentage-danger';
                            return `
                                <tr>
                                    <td class="store-name">${entry.store}</td>
                                    <td>${entry.checkTime}</td>
                                    <td class="amount">$${parseFloat(entry.grossSales).toFixed(2)}</td>
                                    <td class="amount">$${parseFloat(entry.laborDollars).toFixed(2)}</td>
                                    <td class="${pctClass}">${entry.percentage}%</td>
                                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('');
                    console.log('Table updated with', entries.length, 'entries');
                }
            } catch (error) {
                console.error('Error in refreshData:', error);
            }
        };
        
        // Export CSV
        window.exportToCSV = async function() {
            const entries = await loadData();
            if (entries.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Store', 'Check Time', 'Gross Sales', 'Labor Dollars', 'Labor %', 'Timestamp'];
            const rows = entries.map(e => [
                e.store,
                e.checkTime,
                e.grossSales,
                e.laborDollars,
                e.percentage,
                new Date(e.timestamp).toLocaleString()
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `labor-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };
        
        // Event listeners
        document.getElementById('dateFilter').addEventListener('change', refreshData);
        document.getElementById('startDateFilter').addEventListener('change', refreshData);
        document.getElementById('endDateFilter').addEventListener('change', refreshData);
        document.getElementById('timeFilter').addEventListener('change', refreshData);
        
        // Initialize
        buildStoreSelector();
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>